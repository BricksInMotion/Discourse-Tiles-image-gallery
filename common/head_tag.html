<script 
src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js">
</script>
<script 
src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js">
</script>

<script type="text/discourse-plugin" version="0.8.18">
//------------------------------------------
// Tiles I18n Translations
//------------------------------------------
$(document).ready(function() {
  I18n.translations.en.js.composer.tiles_add_images_prompt = settings.Tiles_add_images_prompt;
  I18n.translations.en.js.tiles_gallery_button = settings.Tiles_button_text;
});

//------------------------------------------
// initialize Tiles
//------------------------------------------
var tiles_selector = 'div[data-theme-tiles="1"]';

$.fn.dtiles = function() {
  this.imagesLoaded().progress(function() {
    $(tiles_selector)
      .masonry({
        itemSelector: ".lightbox-wrapper",
        transitionDuration: 0
      })
      .masonry();
  });
  return this;
};

api.decorateCooked($elem =>
  $elem
    .children(tiles_selector)
    .dtiles()
    .addClass("tiles-initialized")
);

//------------------------------------------
// Add Tiles button to the composer toolbar
//------------------------------------------
api.onToolbarCreate(function(toolbar) {
  toolbar.addButton({
    trimLeading: true,
    id: "TilesGallery",
    group: "insertions",
    icon: "th",
    title: "tiles_gallery_button",
    perform: function(e) {
      return e.applySurround(
        '<div data-theme-tiles="1">\n\n',
        "\n\n</div>",
        "tiles_add_images_prompt"
      );
    }
  });
});
</script>
